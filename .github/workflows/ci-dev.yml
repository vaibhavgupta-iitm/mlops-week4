name: CI - Dev Branch

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

# Give workflow proper permissions for CML and repo access
permissions:
  contents: write
  pull-requests: write

jobs:
  test-and-report:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout the repository
      # -----------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # fetch all history for DVC

      # -----------------------------
      # 2. Set up Python
      # -----------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # -----------------------------
      # 3. Install dependencies
      # -----------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[gcs] cml pytest codecov

      # -----------------------------
      # 4. Configure Git (required by DVC)
      # -----------------------------
      - name: Configure Git
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      # -----------------------------
      # 5. Set up Google Cloud auth
      # -----------------------------
      - name: Set up Google Cloud credentials
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      # -----------------------------
      # 6. Setup DVC and pull data/model
      # -----------------------------
      - name: Setup DVC and pull data/model
        run: |
        
          # Configure GCS remote
          dvc remote add -f -d gcsremote gs://mlops-course-verdant-victory-473118-k0-unique-week2-2/iris-pipeline

          # Pull tracked files
          dvc pull iris-dvc-pipeline/v1_data.csv
          dvc pull iris-dvc-pipeline/model.joblib

      # -----------------------------
      # 7. Run tests
      # -----------------------------
      - name: Run data validation tests
        run: pytest tests/test_data_validation.py -v --cov=src --cov-report=xml

      - name: Run model evaluation tests
        run: pytest tests/test_model_evaluation.py -v --cov=src --cov-report=xml

      - name: Run full test suite
        run: pytest tests/ -v --cov=src --cov-report=xml --cov-report=html

      # -----------------------------
      # 8. Upload coverage
      # -----------------------------
      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: dev
          name: dev-coverage

      # -----------------------------
      # 9. Run sanity test
      # -----------------------------
      - name: Run sanity test
        run: python main.py --setup-dvc

      # -----------------------------
      # 10. Install CML
      # -----------------------------
      - name: Install and configure CML
        uses: iterative/setup-cml@v2

      # -----------------------------
      # 11. Generate Markdown report
      # -----------------------------
      - name: Generate test report
        run: |
          echo "## ðŸ§ª Test Results - Dev Branch" > report.md
          echo "" >> report.md
          echo "### ðŸ“Š Test Summary" >> report.md
          echo "- **Branch**: dev" >> report.md
          echo "- **Commit**: ${{ github.sha }}" >> report.md
          echo "- **Status**: âœ… All tests passed" >> report.md
          echo "" >> report.md
          echo "### ðŸ“ˆ Coverage Report" >> report.md
          echo "Coverage details available in the artifacts." >> report.md
          echo "" >> report.md
          echo "### ðŸ” Test Details" >> report.md
          echo "All data validation and model evaluation tests passed successfully." >> report.md
          echo "" >> report.md
          echo "### ðŸš€ Pipeline Status" >> report.md
          echo "âœ… Data validation: PASSED" >> report.md
          echo "âœ… Model evaluation: PASSED" >> report.md
          echo "âœ… DVC integration: PASSED" >> report.md
          echo "âœ… Sanity test: PASSED" >> report.md

      # -----------------------------
      # 12. Post report using CML
      # -----------------------------
      - name: Comment test report with CML
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cml comment create report.md --driver github --token $REPO_TOKEN
